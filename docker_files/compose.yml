version: '3.8' # Recommended

services:
  dbt:
    platform: linux/amd64
    build:
      context: .
      dockerfile: dockerfile.dbt
    container_name: dbt-runner
    environment:
      STORAGE_PATH: "abfss://test-for-uc@uccatalogdelta.dfs.core.windows.net/mydatatable"
      # Pass INTERNAL UC endpoint and ADMIN token from .env
      # Credentials flow through UC server now for writes
      UC_ENDPOINT: "${UC_SERVER_INTERNAL_ENDPOINT}"
      UC_ADMIN_TOKEN: "eyJraWQiOiJjYTgyNDc3ZjkzNzM2MmEyOTdjMTIyZWE3YjRiMzc4Mzg0OTJmMmUwMGUxYWUxMzFiN2ZlYjkzYWQ0NTEzN2E1IiwiYWxnIjoiUlM1MTIiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJhZG1pbiIsImlzcyI6ImludGVybmFsIiwiaWF0IjoxNzQzOTYzODg3LCJqdGkiOiIyZTk0Y2JmNi00ZjMzLTQwZDAtOWEzOS1hYjI3MGFiMDRkNTUiLCJ0eXBlIjoiU0VSVklDRSJ9.iFvYr9VUY3t3hJTZPAh_Qq65Kui88l-SAwZXRDXecMhLkpZsO5Z8ERUt1RWcrcFbKL8JUrD3EHHL1QQlvP4Jc7XdkjqDa8KnwK3uY8B0DG5bo9OKHqILbMuy7obBfRCvfp-ad_qEIJKdOeF4ldb13phP4HYYSfJC2lbKImd7Qi3E4XMYv2IArUHt7WQuWhhCnzUFJU-cpOodUPj90B-dYIwak5a2PZSHXKCSubz3-LS0dQ17YnIL7DQ2XI8X5Ug8M5Wj-um2MegjP1KuRpO57Y49Wk8gBiexLd4FOGbMLeZh_VEbkZD9AUA1PU9DAArqxDTyaZP-RDmDAL6YpZeMTA"
      AZURE_STORAGE_ACCOUNT: "${AZURE_STORAGE_ACCOUNT}"      # For modified plugin -> ADLS
      AZURE_CLIENT_ID: "${AZURE_STORAGE_CLIENT_ID}"      # For modified plugin -> ADLS
      AZURE_CLIENT_SECRET: "${AZURE_STORAGE_CLIENT_SECRET}"  # For modified plugin -> ADLS
      AZURE_TENANT_ID: "${AZURE_STORAGE_TENANT_ID}"      # For modified plugin -> ADLS
      # AZURE_* vars are NOT needed here for the plugin write path anymore
    env_file:
      - .env # Loads vars for substitution in 'environment' block above
    volumes:
      # Mount your dbt project code relative to compose file location
      - .:/usr/app/dbt
      # Remove local storage volume mount if not needed
      # - /Users/mustafakurtoglu/unitycatalog/etc/data/external/data_storage:/data_storage:rw
    networks:
      - data-network
    working_dir: /usr/app/dbt/dataroots_WoodCorps # Adjust to your dbt project location within the mount
    depends_on:
      - unity-catalog

  unity-catalog:
    build:
      context: .
      dockerfile: dockerfile.uc
    # Rename container for clarity and use in endpoint
    container_name: unity-catalogz
    working_dir: /app/unitycatalog
    ports:
      - "8080:8080"
    volumes:
      # Mount ONLY the server.properties file from host to container (read-only)
      - ./uc-conf/server.properties:/app/unitycatalog/etc/conf/server.properties:ro
    networks:
      - data-network
    # Healthcheck removed for simplicity, can be added back later if needed.
    # healthcheck:
    #   test: ["CMD", "curl", "-f", "http://localhost:8080/health"] # Adjust test command as needed
    #   interval: 10s
    #   timeout: 5s
    #   retries: 5
    #   start_period: 30s # Give more time to start

networks:
  data-network:
    driver: bridge

volumes:
  uc-data: # Define the named volume