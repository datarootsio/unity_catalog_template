export LOCATION="francecentral"
export ACI_NAME="unity-catalogz"  
export RG="UC-Catalog"
export STORAGE_ACCT_NAME="uccatalogdelta"
export UC_DB_SHARE="uc-db-share"
export ACR_REGISTRY_NAME="datarootscontainersforucdbt"
export ACR_LOGIN_SERVER="datarootscontainersforucdbt.azurecr.io"
export ACR_USERNAME="datarootscontainersforucdbt"
export UC_IMAGE_NAME="datarootscontainersforucdbt.azurecr.io/uc-server:latest"
export ACR_PASSWORD="$(az acr credential show -n $ACR_REGISTRY_NAME --query 'passwords[0].value' -o tsv)"
export STORAGE_KEY="$(az storage account keys list -g $RG -n $STORAGE_ACCT_NAME --query '[0].value' -o tsv)"
export VNET_NAME="vnet-ucdbt-project" 
export SUBNET_NAME="snet-aci-delegated"


az container create \
  --resource-group $RG \
  --name $ACI_NAME \
  --image $UC_IMAGE_NAME \
  --registry-login-server $ACR_LOGIN_SERVER \
  --registry-username $ACR_REGISTRY_NAME \
  --registry-password "$ACR_PASSWORD" \
  --ip-address Private \
  --vnet $VNET_NAME \
  --vnet-address-prefix 10.0.0.0/16 \
  --subnet $SUBNET_NAME \
  --subnet-address-prefix 10.0.0.0/24 \
  --ports 8080 \
  --protocol TCP \
  --os-type Linux \
  --cpu 1 --memory 1.5 \
  --azure-file-volume-account-name $STORAGE_ACCT_NAME \
  --azure-file-volume-account-key $STORAGE_KEY \
  --azure-file-volume-share-name "$UC_DB_SHARE"\
  --azure-file-volume-mount-path "/app/unitycatalog/etc/db"
  --command-line "bin/start-uc-server"
  
  
  
  az deployment group create \ --resource-group $RG_NAME \ --template-file main.bicep \ --parameters \ storageAccountName=$STORAGE_ACC_NAME \ ucFileShareName=$UC_FILE_SHARE \ keyVaultName=$KV_NAME \ storageAccountKeyValue="$STORAGE_KEY_VALUE" \ acrName=$ACR_NAME \ ucImageName=$UC_IMAGE_FULL \ dbtImageName=$DBT_IMAGE_FULL \ subnetId=$SUBNET_RESOURCE_ID